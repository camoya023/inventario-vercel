<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventrack - Sistema de Inventario</title>

  <!-- Supabase JS Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- External CSS Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

  <!-- Application CSS -->
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/components.css">
  <link rel="stylesheet" href="/css/login.css">
  <link rel="stylesheet" href="/css/home.css">
  <link rel="stylesheet" href="/css/clientes.css">
  <link rel="stylesheet" href="/css/productos.css">
  <link rel="stylesheet" href="/css/proveedores.css">
  <link rel="stylesheet" href="/css/compras.css">
  <link rel="stylesheet" href="/css/ventas.css">

  <style>
    /* Contenedores de vistas */
    .app-container {
      display: none;
      width: 100%;
      min-height: 100vh;
    }
    .app-container.active {
      display: block !important;
    }

    /* Mostrar login por defecto hasta que JavaScript inicialice */
    body:not(.initialized) #login-container {
      display: block;
    }

    /* Asegurar que el body tenga altura completa */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
    }
  </style>
</head>
<body>
  <!-- CONTENEDOR DE LOGIN -->
  <div id="login-container" class="app-container">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-icon">
            <i class="fas fa-boxes"></i>
          </div>
          <h1 class="login-title">Bienvenido</h1>
          <p class="login-subtitle">Ingresa a tu cuenta</p>
        </div>

        <form id="login-form" class="login-form">
          <div class="form-group">
            <label for="email" class="form-label">Correo electrónico</label>
            <div class="input-wrapper">
              <i class="fas fa-envelope input-icon"></i>
              <input
                type="email"
                id="email"
                name="email"
                class="form-input"
                placeholder="tu@email.com"
                required
                autocomplete="email"
              >
            </div>
            <span id="email-error" class="error-message"></span>
          </div>

          <div class="form-group">
            <label for="password" class="form-label">Contraseña</label>
            <div class="input-wrapper">
              <i class="fas fa-lock input-icon"></i>
              <input
                type="password"
                id="password"
                name="password"
                class="form-input"
                placeholder="••••••••"
                required
                autocomplete="current-password"
              >
              <button type="button" id="toggle-password" class="toggle-password" aria-label="Mostrar contraseña">
                <i class="fas fa-eye"></i>
              </button>
            </div>
            <span id="password-error" class="error-message"></span>
          </div>

          <div class="form-group-checkbox">
            <label class="checkbox-label">
              <input
                type="checkbox"
                id="remember-me"
                name="remember-me"
                class="checkbox-input"
              >
              <span class="checkbox-text">Recordarme</span>
            </label>
          </div>

          <button type="submit" id="login-button" class="button button-primary button-full">
            <span id="login-button-text">Iniciar Sesión</span>
            <span id="login-button-spinner" class="spinner" style="display: none;"></span>
          </button>

          <div id="login-error" class="alert alert-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <span id="login-error-message"></span>
          </div>
        </form>
      </div>

      <div class="login-footer">
        <p class="login-footer-text">Sistema de Gestión de Inventario</p>
        <p class="login-footer-version">Versión 2.0</p>
      </div>
    </div>
  </div>

  <!-- CONTENEDOR DE HOME -->
  <div id="home-container" class="app-container">
    <div class="container">
      <div class="top-container">
        <div class="top-container__column left">
          <h1 class="title" id="app-title">Inventrack</h1>
          <p class="subtitle" id="empresa-nombre" style="margin: 0; font-size: 0.95rem; color: #fff; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.2);"></p>
        </div>
        <div class="top-container__column right">
          <div class="quick-menu">
            <i id="addSale" class="fas fa-shopping-cart quick-menu__item" title="Agregar Venta"></i>
            <i id="todaySales" class="fas fa-chart-line quick-menu__item" title="Ventas del Día"></i>
            <i id="stock" class="fas fa-warehouse quick-menu__item" title="Stock"></i>
          </div>
          <div class="user-info">
            <span id="currentDate"></span>
            <span id="loggedUser"></span>
            <button id="logout-button" class="logout-button" title="Cerrar sesión">
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
        </div>
      </div>
      <div class="main-container">
        <div class="sidebar">
          <div id="inicio-link" class="sidebar__item">Inicio</div>
          <div class="sidebar__item" onclick="toggleSubMenu(this)">Contactos</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="clientes-link" class="sidebar__submenu-item">Clientes</div>
            <div id="proveedores-link" class="sidebar__submenu-item">Proveedores</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Productos</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="link-lista-productos" class="sidebar__submenu-item">Lista de productos</div>
            <div id="link-agregar-producto" class="sidebar__submenu-item">Agregar producto</div>
            <div id="link-importar-stock" class="sidebar__submenu-item">Importar Stock Inicial</div>
            <div id="link-categorias" class="sidebar__submenu-item">Categorías</div>
            <div id="link-marcas" class="sidebar__submenu-item">Marcas</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Compras</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="listaCompras-link" class="sidebar__submenu-item">Lista de Compras</div>
            <div id="agregarCompra-link" class="sidebar__submenu-item">Agregar Compra</div>
          </div>

          <div id="ventasMenu" class="sidebar__item" onclick="toggleSubMenu(this)">Ventas</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="listarventas-link" class="sidebar__submenu-item">Lista de Ventas</div>
            <div id="agregarVenta-link" class="sidebar__submenu-item">Nueva Venta</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Gastos</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="lista-gastos-link" class="sidebar__submenu-item">Lista de gastos</div>
            <div id="agregar-gasto-link" class="sidebar__submenu-item">Agregar Gasto</div>
            <div id="categorias-gasto-link" class="sidebar__submenu-item">Categoría de gastos</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Gestión de Inventarios</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="ajustes-inventario-link" class="sidebar__submenu-item">Ajustes de Inventario</div>
            <div id="historial-movimientos-link" class="sidebar__submenu-item">Historial de Movimientos</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Informes</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="informeStock" class="sidebar__submenu-item">Informe de stock</div>
            <div class="sidebar__submenu-item">Productos en tendencia</div>
            <div id="informe-compra-producto-link" class="sidebar__submenu-item">Informe de compra del producto</div>
            <div id="informe-venta-producto-link" class="sidebar__submenu-item">Informe de venta del producto</div>
            <div id="informe-pago-ventas-link" class="sidebar__submenu-item">Informe de pago de ventas</div>
            <div class="sidebar__submenu-item">Informe de gastos</div>
          </div>

          <div class="sidebar__item" onclick="toggleSubMenu(this)">Configuración</div>
          <div class="sidebar__submenu" style="display: none;">
            <div id="config-empresa-link" class="sidebar__submenu-item">Datos de la Empresa</div>
            <div id="config-usuarios-link" class="sidebar__submenu-item">Usuarios y Permisos</div>
            <div id="config-documentos-link" class="sidebar__submenu-item">Formatos de Documentos</div>
            <div id="config-moneda-impuestos-link" class="sidebar__submenu-item">Moneda e Impuestos</div>
            <div id="config-notificaciones-link" class="sidebar__submenu-item">Preferencias de Notificación</div>
            <div id="config-sistema-link" class="sidebar__submenu-item">Parámetros del Sistema</div>
            <div id="config-backup-link" class="sidebar__submenu-item">Copia de Seguridad</div>
          </div>
        </div>
        <div class="work-area">
          <h2>Bienvenido a Inventrack</h2>
          <p>Selecciona una opción del menú lateral para comenzar.</p>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmación Genérica -->
    <div id="modal-confirmacion-generica" class="modal-overlay" style="display: none;">
      <div class="modal-content modal-sm">
        <div class="modal-header">
          <h3 id="modal-confirmacion-generica-titulo" class="modal-title">Confirmar Acción</h3>
          <button id="btn-cerrar-modal-confirmacion-generica-x" class="modal-close-button" aria-label="Cerrar modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <p id="modal-confirmacion-generica-mensaje">¿Estás seguro de que quieres continuar?</p>
        </div>
        <div class="modal-footer">
          <button type="button" id="btn-cancelar-modal-confirmacion-generica" class="button button-secondary">Cancelar</button>
          <button type="button" id="btn-aceptar-modal-confirmacion-generica" class="button button-danger">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" aria-live="assertive" aria-atomic="true"></div>
  </div>

  <!-- External JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Application JavaScript -->
  <!-- Config local debe cargarse ANTES de config.js -->
  <script src="/js/config.local.js"></script>
  <script src="/js/config.js"></script>
  <script src="/js/utils.js"></script>
  <script src="/js/login.js"></script>
  <script src="/js/home.js"></script>
  <script src="/js/clientes-lista.js"></script>
  <script src="/js/clientes-formulario.js"></script>
  <script src="/js/clientes-detalle.js"></script>
  <script src="/js/proveedores-lista.js"></script>
  <script src="/js/compras-lista.js"></script>
  <script src="/js/compras-formulario.js"></script>
  <script src="/js/compras-detalle.js"></script>
  <script src="/js/ventas-lista.js"></script>
  <script src="/js/ventas-formulario.js"></script>
  <script src="/js/ventas-detalle.js"></script>

  <!-- Application Logic -->
  <script>
    // ========================================
    // NAVEGACIÓN ENTRE LOGIN Y HOME
    // ========================================

    // Callback global cuando el login es exitoso
    window.onLoginSuccess = async function(user) {
      console.log('[APP] Login exitoso, mostrando home para:', user.email);
      await mostrarVista('home');
    };

    // Función global para mostrar vistas
    window.mostrarVista = async function mostrarVista(vistaId) {
      // Ocultar todos los contenedores
      document.querySelectorAll('.app-container').forEach(container => {
        container.classList.remove('active');
      });

      // Mostrar el contenedor solicitado
      const container = document.getElementById(vistaId + '-container');
      if (container) {
        container.classList.add('active');
        console.log('[APP] Vista activada:', vistaId);

        // Inicializar la vista según corresponda
        if (vistaId === 'login') {
          await inicializarLogin();
        } else if (vistaId === 'home') {
          await inicializarHome();
        }
      } else {
        console.error('[APP] No se encontró el contenedor:', vistaId + '-container');
      }
    }

    // Inicialización de la aplicación
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('[APP] ========== APLICACIÓN INICIADA ==========');

      try {
        // Inicializar cliente de Supabase UNA SOLA VEZ
        await inicializarSupabaseClient();
        console.log('[APP] Cliente de Supabase inicializado');

        // Verificar si hay sesión guardada
        const sessionData = localStorage.getItem('user_session') || sessionStorage.getItem('user_session');

        if (sessionData) {
          try {
            const session = JSON.parse(sessionData);
            const ahora = new Date().getTime();
            const tiempoTranscurrido = ahora - session.timestamp;

            // Si hay sesión válida (menos de 24 horas)
            if (tiempoTranscurrido < 86400000 && session.user) {
              console.log('[APP] Sesión válida encontrada, mostrando home');
              await mostrarVista('home');
            } else {
              console.log('[APP] Sesión expirada, mostrando login');
              await mostrarVista('login');
            }
          } catch (e) {
            console.error('[APP] Error parseando sesión:', e);
            await mostrarVista('login');
          }
        } else {
          console.log('[APP] No hay sesión, mostrando login');
          await mostrarVista('login');
        }

        // Marcar como inicializado
        document.body.classList.add('initialized');
      } catch (error) {
        console.error('[APP] Error fatal inicializando aplicación:', error);
        alert('Error al inicializar la aplicación. Por favor, recarga la página.');
      }
    });
  </script>
</body>
</html>
